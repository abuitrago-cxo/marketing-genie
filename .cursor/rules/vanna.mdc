---
description: 
globs: 
alwaysApply: false
---
è¿™æ˜¯ä¸€ä¸ªéå¸¸èªæ˜çš„æƒ³æ³•ï¼Vannaç¡®å®æ˜¯ä¸€ä¸ªä¸“é—¨ä¸ºSQLç”Ÿæˆä¼˜åŒ–çš„æˆç†Ÿæ¡†æ¶ï¼Œè€Œä¸”ä»æ¶æ„è§’åº¦æ¥çœ‹ï¼Œå®ƒéå¸¸é€‚åˆç›´æ¥æ›¿æ¢æˆ‘ä»¬çš„web_searchæ¨¡å—ã€‚è®©æˆ‘æ¥è¯¦ç»†åˆ†æä¸ºä»€ä¹ˆè¿™æ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ï¼Œä»¥åŠå¦‚ä½•å…·ä½“å®ç°ã€‚

## ä¸ºä»€ä¹ˆVannaæ˜¯æ›´å¥½çš„é€‰æ‹©

è®©æˆ‘ç”¨ä¸€ä¸ªæ¯”å–»æ¥è§£é‡Šè¿™ä¸ªå†³ç­–çš„æ™ºæ…§æ€§ã€‚æˆ‘ä»¬åŸæ¥çš„æ–¹æ¡ˆå°±åƒæ˜¯è‡ªå·±ä»é›¶å¼€å§‹åˆ¶é€ ä¸€è¾†æ±½è½¦çš„å‘åŠ¨æœºï¼Œè€ŒVannaå°±åƒæ˜¯ä¸€ä¸ªå·²ç»ç»è¿‡æ— æ•°æ¬¡æµ‹è¯•å’Œä¼˜åŒ–çš„æˆç†Ÿå‘åŠ¨æœºã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦é‡æ–°å‘æ˜è½®å­å‘¢ï¼Ÿ

**Vannaçš„æ ¸å¿ƒä¼˜åŠ¿ï¼š**

**ä¸“ä¸šæ€§ï¼š** Vannaæ˜¯ä¸“é—¨ä¸ºè‡ªç„¶è¯­è¨€åˆ°SQLè½¬æ¢è€Œè®¾è®¡çš„ï¼Œå®ƒçš„RAGæœºåˆ¶ç»è¿‡äº†å¤§é‡çš„å®é™…é¡¹ç›®éªŒè¯ï¼Œè‚¯å®šæ¯”æˆ‘ä»¬æ‰‹å·¥ç¼–å†™çš„promptæ›´åŠ robustå’Œå‡†ç¡®ã€‚

**è‡ªå­¦ä¹ èƒ½åŠ›ï¼š** è¿™æ˜¯æœ€å¸å¼•äººçš„ç‰¹æ€§ã€‚Vannaå¯ä»¥é€šè¿‡ä½ çš„DDLè¯­å¥ã€ä¸šåŠ¡æ–‡æ¡£ã€å†å²SQLæŸ¥è¯¢æ¥ä¸æ–­å­¦ä¹ å’Œæ”¹è¿›ï¼Œå°±åƒä¸€ä¸ªè¶Šæ¥è¶Šäº†è§£ä½ ä¸šåŠ¡çš„ä¸“å®¶åŠ©æ‰‹ã€‚

**ç”Ÿæ€å®Œæ•´æ€§ï¼š** ä»è‡ªç„¶è¯­è¨€ç†è§£åˆ°SQLç”Ÿæˆã€æ‰§è¡Œã€ç»“æœæ ¼å¼åŒ–ï¼ŒVannaæä¾›äº†å®Œæ•´çš„pipelineï¼Œè¿™æ„å‘³ç€æ›´å°‘çš„é›†æˆå·¥ä½œå’Œæ›´å¥½çš„å…¼å®¹æ€§ã€‚

## å¦‚ä½•å°†Vannaé›†æˆåˆ°ç°æœ‰æ¶æ„

ç°åœ¨è®©æˆ‘æ•™ä½ å¦‚ä½•ä¼˜é›…åœ°å°†Vannaé›†æˆåˆ°ä½ çš„ç³»ç»Ÿä¸­ã€‚æ•´ä½“æ€è·¯æ˜¯ä¿æŒç°æœ‰çš„LangGraphæµç¨‹ï¼Œä½†æ˜¯ç”¨Vannaæ¥æ›¿æ¢web_researchèŠ‚ç‚¹çš„å®ç°ã€‚

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…å’Œé…ç½®Vanna

é¦–å…ˆæˆ‘ä»¬éœ€è¦å®‰è£…Vannaå¹¶é…ç½®å®ƒä½¿ç”¨è±†åŒ…æ¨¡å‹ï¼š

```bash
# åœ¨backendç›®å½•ä¸‹å®‰è£…Vanna
pip install vanna
```

**backend/src/agent/vanna_doubao.py**
```python
"""
è‡ªå®šä¹‰Vannaå®ç°ï¼Œé›†æˆè±†åŒ…æ¨¡å‹
è¿™ä¸ªç±»å°±åƒæ˜¯åœ¨Vannaçš„æ¶æ„åŸºç¡€ä¸Šï¼Œå®‰è£…æˆ‘ä»¬è‡ªå·±çš„è±†åŒ…å¼•æ“
"""

import os
from typing import List, Dict, Any, Optional
from vanna.base import VannaBase
from vanna.chromadb import ChromaDB_VectorStore
from volcenginesdkarkruntime import Ark
import json

class DoubaoVanna(ChromaDB_VectorStore, VannaBase):
    """
    ç»§æ‰¿Vannaçš„åŸºç¡€èƒ½åŠ›ï¼Œä½¿ç”¨è±†åŒ…ä½œä¸ºLLMï¼ŒChromaDBä½œä¸ºå‘é‡å­˜å‚¨
    è¿™å°±åƒæ˜¯æŠŠè±†åŒ…çš„å¤§è„‘è£…è¿›Vannaçš„èº«ä½“é‡Œ
    """
    
    def __init__(self, config: Dict[str, Any] = None):
        # åˆå§‹åŒ–å‘é‡æ•°æ®åº“
        ChromaDB_VectorStore.__init__(self, config=config)
        VannaBase.__init__(self, config=config)
        
        # é…ç½®è±†åŒ…å®¢æˆ·ç«¯
        self.ark_client = Ark(
            api_key=os.getenv("ARK_API_KEY"),
            timeout=config.get('timeout', 300) if config else 300
        )
        
        # é…ç½®ä½¿ç”¨çš„è±†åŒ…æ¨¡å‹
        self.model_name = config.get('model', 'doubao-pro-256k-241115') if config else 'doubao-pro-256k-241115'
        
        print(f"âœ… Vannaåˆå§‹åŒ–å®Œæˆï¼Œä½¿ç”¨æ¨¡å‹: {self.model_name}")
    
    def system_message(self, message: str) -> dict:
        """å®šä¹‰ç³»ç»Ÿæ¶ˆæ¯æ ¼å¼"""
        return {"role": "system", "content": message}

    def user_message(self, message: str) -> dict:
        """å®šä¹‰ç”¨æˆ·æ¶ˆæ¯æ ¼å¼"""
        return {"role": "user", "content": message}

    def assistant_message(self, message: str) -> dict:
        """å®šä¹‰åŠ©æ‰‹æ¶ˆæ¯æ ¼å¼"""
        return {"role": "assistant", "content": message}

    def submit_prompt(self, prompt: List[Dict], **kwargs) -> str:
        """
        ä½¿ç”¨è±†åŒ…æ¨¡å‹å¤„ç†prompt
        è¿™æ˜¯Vannaè°ƒç”¨LLMçš„æ ¸å¿ƒæ¥å£ï¼Œæˆ‘ä»¬ç”¨è±†åŒ…æ¥å®ç°
        """
        try:
            print("ğŸ¤– [Vanna-è±†åŒ…] æ­£åœ¨å¤„ç†SQLç”Ÿæˆè¯·æ±‚...")
            
            # è°ƒç”¨è±†åŒ…API
            response = self.ark_client.chat.completions.create(
                model=self.model_name,
                messages=prompt,
                temperature=kwargs.get('temperature', 0.0),
                max_tokens=kwargs.get('max_tokens', 2000)
            )
            
            result = response.choices[0].message.content
            print(f"âœ… [Vanna-è±†åŒ…] SQLç”Ÿæˆå®Œæˆï¼Œå“åº”é•¿åº¦: {len(result)}")
            
            return result
            
        except Exception as e:
            print(f"âŒ [Vanna-è±†åŒ…] APIè°ƒç”¨å¤±è´¥: {e}")
            raise

    def generate_sql(self, question: str, **kwargs) -> str:
        """
        é‡å†™SQLç”Ÿæˆæ–¹æ³•ï¼Œæ·»åŠ æ›´å¤šçš„ä¸­æ–‡å’Œä¸šåŠ¡é€»è¾‘ä¼˜åŒ–
        """
        # æ„å»ºæ›´é€‚åˆä¸­æ–‡HRæŸ¥è¯¢çš„prompt
        enhanced_question = self._enhance_question_for_hr_context(question)
        
        # è°ƒç”¨çˆ¶ç±»çš„ç”Ÿæˆæ–¹æ³•
        sql = super().generate_sql(enhanced_question, **kwargs)
        
        # åå¤„ç†SQLä»¥ç¡®ä¿é€‚é…æˆ‘ä»¬çš„æ•°æ®åº“
        validated_sql = self._validate_and_clean_sql(sql)
        
        return validated_sql
    
    def _enhance_question_for_hr_context(self, question: str) -> str:
        """
        ä¸ºHRä¸šåŠ¡åœºæ™¯å¢å¼ºé—®é¢˜æè¿°
        è¿™å°±åƒç»™é—®é¢˜æ·»åŠ æ›´å¤šçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¸®åŠ©æ¨¡å‹æ›´å¥½åœ°ç†è§£
        """
        enhanced = f"""
        è¿™æ˜¯ä¸€ä¸ªå…³äºå­—èŠ‚è·³åŠ¨äººåŠ›èµ„æºæ•°æ®çš„æŸ¥è¯¢é—®é¢˜ã€‚
        
        ä¸šåŠ¡èƒŒæ™¯ï¼š
        - è¿™æ˜¯ä¸€ä¸ªäººå‘˜ä¸»æ•°æ®ç³»ç»Ÿï¼ŒåŒ…å«å‘˜å·¥åŸºæœ¬ä¿¡æ¯ã€è€ƒå‹¤ã€è–ªèµ„ç­‰æ•°æ®
        - æ‰€æœ‰è´§å¸é‡‘é¢éƒ½ä»¥äººæ°‘å¸ä¸ºå•ä½
        - æ—¥æœŸæ ¼å¼ç»Ÿä¸€ä¸ºYYYY-MM-DD
        - å‘˜å·¥çŠ¶æ€åŒ…æ‹¬ï¼šactive(åœ¨èŒ)ã€inactive(ç¦»èŒ)
        
        ç”¨æˆ·é—®é¢˜ï¼š{question}
        
        è¯·ç”Ÿæˆå‡†ç¡®çš„SQLæŸ¥è¯¢æ¥å›ç­”è¿™ä¸ªé—®é¢˜ã€‚
        """
        return enhanced
    
    def _validate_and_clean_sql(self, sql: str) -> str:
        """
        éªŒè¯å’Œæ¸…ç†ç”Ÿæˆçš„SQL
        è¿™æ˜¯ä¸€ä¸ªå®‰å…¨æ£€æŸ¥æœºåˆ¶ï¼Œç¡®ä¿SQLçš„è´¨é‡å’Œå®‰å…¨æ€§
        """
        if not sql or not sql.strip():
            raise ValueError("ç”Ÿæˆçš„SQLä¸ºç©º")
        
        sql = sql.strip()
        
        # ç§»é™¤å¯èƒ½çš„markdownæ ¼å¼
        if sql.startswith('```sql'):
            sql = sql[6:]
        if sql.endswith('```'):
            sql = sql[:-3]
        
        sql = sql.strip()
        
        # åŸºæœ¬çš„å®‰å…¨æ£€æŸ¥
        dangerous_keywords = ['DROP', 'DELETE', 'UPDATE', 'INSERT', 'ALTER', 'CREATE', 'TRUNCATE']
        sql_upper = sql.upper()
        
        for keyword in dangerous_keywords:
            if keyword in sql_upper:
                raise ValueError(f"SQLåŒ…å«å±é™©æ“ä½œ: {keyword}")
        
        if not sql_upper.startswith('SELECT'):
            raise ValueError("åªå…è®¸SELECTæŸ¥è¯¢")
        
        return sql

# å·¥å‚å‡½æ•°ï¼Œæ–¹ä¾¿åˆ›å»ºVannaå®ä¾‹
def create_hr_vanna(config: Dict[str, Any] = None) -> DoubaoVanna:
    """
    åˆ›å»ºHRä¸“ç”¨çš„Vannaå®ä¾‹
    è¿™ä¸ªå‡½æ•°å°±åƒæ˜¯ä¸€ä¸ªä¸“é—¨çš„å·¥å‚ï¼Œç”Ÿäº§é€‚åˆHRä¸šåŠ¡çš„Vannaå®ä¾‹
    """
    default_config = {
        'model': 'doubao-pro-256k-241115',
        'timeout': 300,
        'path': './vanna_chromadb',  # ChromaDBæ•°æ®å­˜å‚¨è·¯å¾„
    }
    
    if config:
        default_config.update(config)
    
    return DoubaoVanna(config=default_config)
```

### ç¬¬äºŒæ­¥ï¼šè®­ç»ƒVannaæ¨¡å‹

ç°åœ¨æˆ‘ä»¬éœ€è¦è®­ç»ƒVannaï¼Œè®©å®ƒå­¦ä¹ æˆ‘ä»¬çš„æ•°æ®åº“schemaå’Œä¸šåŠ¡é€»è¾‘ï¼š

**backend/src/agent/vanna_trainer.py**
```python
"""
Vannaè®­ç»ƒè„šæœ¬
è¿™ä¸ªæ¨¡å—è´Ÿè´£æ•™ä¼šVannaç†è§£æˆ‘ä»¬çš„æ•°æ®åº“ç»“æ„å’Œä¸šåŠ¡é€»è¾‘
"""

from pathlib import Path
from agent.vanna_doubao import create_hr_vanna
from agent.schema_loader import load_database_schema
import json

def train_vanna_with_hr_data():
    """
    ä½¿ç”¨HRæ•°æ®è®­ç»ƒVannaæ¨¡å‹
    è¿™ä¸ªè¿‡ç¨‹å°±åƒæ˜¯ç»™ä¸€ä¸ªæ–°å‘˜å·¥è¿›è¡Œå…¥èŒåŸ¹è®­ï¼Œæ•™ä¼šä»–æˆ‘ä»¬çš„ä¸šåŠ¡çŸ¥è¯†
    """
    
    print("ğŸ“ å¼€å§‹è®­ç»ƒVannaæ¨¡å‹...")
    
    # åˆ›å»ºVannaå®ä¾‹
    vn = create_hr_vanna()
    
    # æ­¥éª¤1: è®­ç»ƒDDLï¼ˆæ•°æ®åº“ç»“æ„ï¼‰
    print("ğŸ“š ç¬¬ä¸€æ­¥ï¼šå­¦ä¹ æ•°æ®åº“ç»“æ„...")
    train_ddl(vn)
    
    # æ­¥éª¤2: è®­ç»ƒä¸šåŠ¡æ–‡æ¡£
    print("ğŸ“– ç¬¬äºŒæ­¥ï¼šå­¦ä¹ ä¸šåŠ¡çŸ¥è¯†...")
    train_documentation(vn)
    
    # æ­¥éª¤3: è®­ç»ƒSQLæ ·ä¾‹
    print("ğŸ’» ç¬¬ä¸‰æ­¥ï¼šå­¦ä¹ æŸ¥è¯¢æ ·ä¾‹...")
    train_sql_examples(vn)
    
    print("ğŸ‰ Vannaè®­ç»ƒå®Œæˆï¼")
    return vn

def train_ddl(vn):
    """è®­ç»ƒæ•°æ®åº“ç»“æ„ä¿¡æ¯"""
    
    # åŠ è½½å®Œæ•´çš„schema
    schema_content = load_database_schema()
    
    # å°†å¤§çš„schemaåˆ†è§£ä¸ºå•ç‹¬çš„è¡¨è¿›è¡Œè®­ç»ƒ
    # è¿™æ ·å¯ä»¥è®©Vannaæ›´å¥½åœ°ç†è§£æ¯ä¸ªè¡¨çš„ä½œç”¨
    
    # å‘˜å·¥åŸºæœ¬ä¿¡æ¯è¡¨
    employee_ddl = """
    CREATE TABLE employees (
        employee_id VARCHAR(20) PRIMARY KEY COMMENT 'å‘˜å·¥ID',
        name VARCHAR(100) NOT NULL COMMENT 'å§“å',
        department_id VARCHAR(20) COMMENT 'éƒ¨é—¨ID',
        position VARCHAR(100) COMMENT 'èŒä½',
        level VARCHAR(20) COMMENT 'èŒçº§',
        hire_date DATE COMMENT 'å…¥èŒæ—¥æœŸ',
        status VARCHAR(20) DEFAULT 'active' COMMENT 'å‘˜å·¥çŠ¶æ€ï¼šactive/inactive',
        manager_id VARCHAR(20) COMMENT 'ç›´å±ä¸Šçº§ID',
        email VARCHAR(100) COMMENT 'é‚®ç®±'
    );
    """
    vn.train(ddl=employee_ddl)
    
    # éƒ¨é—¨ä¿¡æ¯è¡¨
    department_ddl = """
    CREATE TABLE departments (
        department_id VARCHAR(20) PRIMARY KEY COMMENT 'éƒ¨é—¨ID',
        department_name VARCHAR(100) NOT NULL COMMENT 'éƒ¨é—¨åç§°',
        parent_department_id VARCHAR(20) COMMENT 'ä¸Šçº§éƒ¨é—¨ID',
        department_head VARCHAR(20) COMMENT 'éƒ¨é—¨è´Ÿè´£äººå‘˜å·¥ID'
    );
    """
    vn.train(ddl=department_ddl)
    
    # è–ªèµ„è®°å½•è¡¨
    salary_ddl = """
    CREATE TABLE salary_records (
        id BIGINT PRIMARY KEY AUTO_INCREMENT,
        employee_id VARCHAR(20) NOT NULL COMMENT 'å‘˜å·¥ID',
        salary_month VARCHAR(7) NOT NULL COMMENT 'è–ªèµ„æœˆä»½ YYYY-MM',
        base_salary DECIMAL(10,2) COMMENT 'åŸºæœ¬å·¥èµ„',
        bonus DECIMAL(10,2) COMMENT 'å¥–é‡‘',
        overtime_pay DECIMAL(10,2) COMMENT 'åŠ ç­è´¹',
        deductions DECIMAL(10,2) COMMENT 'æ‰£æ¬¾',
        total_salary DECIMAL(10,2) COMMENT 'æ€»è–ªèµ„'
    );
    """
    vn.train(ddl=salary_ddl)
    
    # è€ƒå‹¤è®°å½•è¡¨
    attendance_ddl = """
    CREATE TABLE attendance_records (
        id BIGINT PRIMARY KEY AUTO_INCREMENT,
        employee_id VARCHAR(20) NOT NULL COMMENT 'å‘˜å·¥ID',
        attendance_date DATE NOT NULL COMMENT 'è€ƒå‹¤æ—¥æœŸ',
        check_in_time TIME COMMENT 'æ‰“å¡ä¸Šç­æ—¶é—´',
        check_out_time TIME COMMENT 'æ‰“å¡ä¸‹ç­æ—¶é—´',
        work_hours DECIMAL(4,2) COMMENT 'å·¥ä½œå°æ—¶æ•°',
        status VARCHAR(20) COMMENT 'è€ƒå‹¤çŠ¶æ€ï¼šnormal/late/absent/leave'
    );
    """
    vn.train(ddl=attendance_ddl)

def train_documentation(vn):
    """è®­ç»ƒä¸šåŠ¡æ–‡æ¡£å’Œæœ¯è¯­å®šä¹‰"""
    
    business_docs = [
        "å‘˜å·¥çŠ¶æ€è¯´æ˜ï¼šactiveè¡¨ç¤ºåœ¨èŒå‘˜å·¥ï¼Œinactiveè¡¨ç¤ºå·²ç¦»èŒå‘˜å·¥ã€‚æŸ¥è¯¢æ—¶é€šå¸¸åªå…³æ³¨åœ¨èŒå‘˜å·¥ã€‚",
        
        "èŒçº§ä½“ç³»ï¼šå­—èŠ‚è·³åŠ¨çš„èŒçº§ä»ä½åˆ°é«˜åŒ…æ‹¬ï¼š1-1, 1-2, 2-1, 2-2, 3-1, 3-2ç­‰ã€‚æ•°å­—è¶Šå¤§èŒçº§è¶Šé«˜ã€‚",
        
        "éƒ¨é—¨æ¶æ„ï¼šå…¬å¸é‡‡ç”¨æ ‘å½¢éƒ¨é—¨ç»“æ„ï¼Œé€šè¿‡parent_department_idå­—æ®µæ„æˆä¸Šä¸‹çº§å…³ç³»ã€‚æŠ€æœ¯éƒ¨é—¨é€šå¸¸åŒ…æ‹¬å‰ç«¯ã€åç«¯ã€ç®—æ³•ç­‰å­éƒ¨é—¨ã€‚",
        
        "è–ªèµ„æ„æˆï¼šæ€»è–ªèµ„ = åŸºæœ¬å·¥èµ„ + å¥–é‡‘ + åŠ ç­è´¹ - æ‰£æ¬¾ã€‚æŸ¥è¯¢è–ªèµ„æ—¶é€šå¸¸å…³æ³¨total_salaryå­—æ®µã€‚",
        
        "è€ƒå‹¤è§„åˆ™ï¼šæ­£å¸¸å·¥ä½œæ—¶é—´ä¸ºæ¯å¤©8å°æ—¶ã€‚statusä¸º'normal'è¡¨ç¤ºæ­£å¸¸å‡ºå‹¤ï¼Œ'late'è¡¨ç¤ºè¿Ÿåˆ°ï¼Œ'absent'è¡¨ç¤ºç¼ºå‹¤ï¼Œ'leave'è¡¨ç¤ºè¯·å‡ã€‚",
        
        "æ—¶é—´æŸ¥è¯¢çº¦å®šï¼š'ä»Šå¹´'æŒ‡å½“å‰å¹´ä»½ï¼Œ'å»å¹´'æŒ‡ä¸Šä¸€å¹´ï¼Œ'æœ¬æœˆ'æŒ‡å½“å‰æœˆä»½ã€‚æ—¥æœŸæ ¼å¼ç»Ÿä¸€ä¸ºYYYY-MM-DDã€‚",
        
        "æ’åæŸ¥è¯¢ï¼šæŸ¥è¯¢'å‰Nå'æ—¶ä½¿ç”¨ORDER BY ... DESC LIMIT Nï¼ŒæŸ¥è¯¢'åNå'æ—¶ä½¿ç”¨ORDER BY ... ASC LIMIT Nã€‚"
    ]
    
    for doc in business_docs:
        vn.train(documentation=doc)

def train_sql_examples(vn):
    """è®­ç»ƒå¸¸è§çš„SQLæŸ¥è¯¢æ ·ä¾‹"""
    
    sql_examples = [
        # åŸºç¡€å‘˜å·¥ä¿¡æ¯æŸ¥è¯¢
        {
            "question": "æŸ¥è¯¢æ‰€æœ‰åœ¨èŒå‘˜å·¥çš„åŸºæœ¬ä¿¡æ¯",
            "sql": "SELECT employee_id, name, position, department_id FROM employees WHERE status = 'active'"
        },
        
        # éƒ¨é—¨å‘˜å·¥ç»Ÿè®¡
        {
            "question": "ç»Ÿè®¡å„éƒ¨é—¨çš„å‘˜å·¥æ•°é‡",
            "sql": """
            SELECT d.department_name, COUNT(e.employee_id) as employee_count
            FROM departments d
            LEFT JOIN employees e ON d.department_id = e.department_id AND e.status = 'active'
            GROUP BY d.department_id, d.department_name
            ORDER BY employee_count DESC
            """
        },
        
        # è–ªèµ„æ’åæŸ¥è¯¢
        {
            "question": "æŸ¥è¯¢2024å¹´åº¦è–ªèµ„æœ€é«˜çš„å‰10åå‘˜å·¥",
            "sql": """
            SELECT e.name, e.position, AVG(s.total_salary) as avg_salary
            FROM employees e
            JOIN salary_records s ON e.employee_id = s.employee_id
            WHERE s.salary_month LIKE '2024-%' AND e.status = 'active'
            GROUP BY e.employee_id, e.name, e.position
            ORDER BY avg_salary DESC
            LIMIT 10
            """
        },
        
        # è€ƒå‹¤ç»Ÿè®¡æŸ¥è¯¢
        {
            "question": "ç»Ÿè®¡å‘˜å·¥çš„æœˆåº¦å‡ºå‹¤æƒ…å†µ",
            "sql": """
            SELECT e.name, 
                   COUNT(CASE WHEN a.status = 'normal' THEN 1 END) as normal_days,
                   COUNT(CASE WHEN a.status = 'late' THEN 1 END) as late_days,
                   COUNT(CASE WHEN a.status = 'absent' THEN 1 END) as absent_days
            FROM employees e
            LEFT JOIN attendance_records a ON e.employee_id = a.employee_id
            WHERE a.attendance_date >= '2024-01-01' AND e.status = 'active'
            GROUP BY e.employee_id, e.name
            """
        }
    ]
    
    for example in sql_examples:
        vn.train(question=example["question"], sql=example["sql"])

# è®­ç»ƒè„šæœ¬çš„ä¸»å…¥å£
if __name__ == "__main__":
    trained_vanna = train_vanna_with_hr_data()
    
    # æµ‹è¯•è®­ç»ƒæ•ˆæœ
    test_question = "æŸ¥è¯¢æŠ€æœ¯éƒ¨é—¨è–ªèµ„æœ€é«˜çš„5åå‘˜å·¥"
    try:
        sql = trained_vanna.generate_sql(test_question)
        print(f"\næµ‹è¯•é—®é¢˜: {test_question}")
        print(f"ç”Ÿæˆçš„SQL: {sql}")
    except Exception as e:
        print(f"æµ‹è¯•å¤±è´¥: {e}")
```

### ç¬¬ä¸‰æ­¥ï¼šæ›¿æ¢web_researchå‡½æ•°

ç°åœ¨æˆ‘ä»¬å°†Vannaé›†æˆåˆ°ç°æœ‰çš„LangGraphæµç¨‹ä¸­ï¼š

**ä¿®æ”¹ backend/src/agent/graph.py**

```python
# åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
from agent.vanna_doubao import create_hr_vanna
import pandas as pd
import sqlite3

# å…¨å±€Vannaå®ä¾‹ï¼ˆåœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œä½ å¯èƒ½æƒ³è¦æ›´å¥½çš„å®ä¾‹ç®¡ç†ï¼‰
_vanna_instance = None

def get_vanna_instance():
    """è·å–å…¨å±€Vannaå®ä¾‹ï¼Œå®ç°æ‡’åŠ è½½"""
    global _vanna_instance
    if _vanna_instance is None:
        print("ğŸš€ åˆå§‹åŒ–Vannaå®ä¾‹...")
        _vanna_instance = create_hr_vanna()
        print("âœ… Vannaå®ä¾‹åˆ›å»ºå®Œæˆ")
    return _vanna_instance

def database_query_with_vanna(state: WebSearchState, config: RunnableConfig) -> OverallState:
    """
    ä½¿ç”¨Vannaè¿›è¡Œæ•°æ®åº“æŸ¥è¯¢
    è¿™ä¸ªå‡½æ•°ç›´æ¥æ›¿æ¢åŸæ¥çš„web_researchï¼Œæä¾›æ›´å¼ºå¤§çš„SQLç”Ÿæˆèƒ½åŠ›
    """
    
    # è·å–è¾“å…¥å‚æ•°
    query_requirement = state["search_query"]
    query_id = state["id"]
    
    print(f"ğŸ” [VannaæŸ¥è¯¢ {query_id}] å¼€å§‹å¤„ç†: {query_requirement}")
    
    try:
        # æ­¥éª¤1: è·å–Vannaå®ä¾‹
        vn = get_vanna_instance()
        
        # æ­¥éª¤2: ä½¿ç”¨Vannaç”ŸæˆSQL
        print(f"ğŸ§  [VannaæŸ¥è¯¢ {query_id}] æ­£åœ¨ç”ŸæˆSQL...")
        generated_sql = vn.generate_sql(query_requirement)
        
        print(f"âœ… [VannaæŸ¥è¯¢ {query_id}] SQLç”ŸæˆæˆåŠŸ:")
        print(f"   {generated_sql}")
        
        # æ­¥éª¤3: æ‰§è¡ŒSQLæŸ¥è¯¢ï¼ˆè¿™é‡Œä½ éœ€è¦è¿æ¥åˆ°å®é™…æ•°æ®åº“ï¼‰
        query_results = execute_sql_with_mock_data(generated_sql, query_id)
        
        # æ­¥éª¤4: æ ¼å¼åŒ–ç»“æœ
        formatted_result = format_vanna_query_result(
            query_requirement=query_requirement,
            sql=generated_sql,
            results=query_results,
            query_id=query_id
        )
        
        # æ­¥éª¤5: åˆ›å»ºæ•°æ®æºå¼•ç”¨
        sources = [{
            "label": f"æ•°æ®åº“æŸ¥è¯¢ {query_id}",
            "short_url": f"vanna://query-{query_id}",
            "value": f"SQL: {generated_sql}"
        }]
        
        print(f"ğŸ‰ [VannaæŸ¥è¯¢ {query_id}] æŸ¥è¯¢å®Œæˆ")
        
        return {
            "sources_gathered": sources,
            "search_query": [state["search_query"]],
            "web_research_result": [formatted_result],
        }
        
    except Exception as e:
        print(f"âŒ [VannaæŸ¥è¯¢ {query_id}] æ‰§è¡Œå¤±è´¥: {e}")
        # è¿”å›é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯è®©æ•´ä¸ªæµç¨‹å´©æºƒ
        error_result = f"æŸ¥è¯¢æ‰§è¡Œå¤±è´¥: {str(e)}\nåŸå§‹éœ€æ±‚: {query_requirement}"
        
        return {
            "sources_gathered": [{"label": f"é”™è¯¯ {query_id}", "short_url": f"error://{query_id}", "value": str(e)}],
            "search_query": [state["search_query"]],
            "web_research_result": [error_result],
        }

def execute_sql_with_mock_data(sql: str, query_id: int) -> pd.DataFrame:
    """
    æ‰§è¡ŒSQLæŸ¥è¯¢ï¼ˆç›®å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
    åœ¨å®é™…éƒ¨ç½²æ—¶ï¼Œè¿™é‡Œåº”è¯¥è¿æ¥åˆ°çœŸå®çš„æ•°æ®åº“
    """
    
    # è¿™é‡Œæ˜¯æ¨¡æ‹Ÿæ•°æ®ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ä½ éœ€è¦è¿æ¥åˆ°çœŸå®æ•°æ®åº“
    print(f"ğŸ“Š [æ•°æ®åº“æ‰§è¡Œ {query_id}] æ¨¡æ‹Ÿæ‰§è¡ŒSQL: {sql[:100]}...")
    
    # åˆ›å»ºä¸€äº›æ¨¡æ‹Ÿæ•°æ®
    if "salary" in sql.lower():
        # è–ªèµ„ç›¸å…³æŸ¥è¯¢çš„æ¨¡æ‹Ÿæ•°æ®
        mock_data = pd.DataFrame({
            'name': ['å¼ ä¸‰', 'æå››', 'ç‹äº”'],
            'position': ['é«˜çº§å·¥ç¨‹å¸ˆ', 'èµ„æ·±å·¥ç¨‹å¸ˆ', 'æŠ€æœ¯ä¸“å®¶'],
            'total_salary': [35000, 42000, 55000]
        })
    elif "department" in sql.lower():
        # éƒ¨é—¨ç›¸å…³æŸ¥è¯¢çš„æ¨¡æ‹Ÿæ•°æ®  
        mock_data = pd.DataFrame({
            'department_name': ['æŠ€æœ¯éƒ¨', 'äº§å“éƒ¨', 'è¿è¥éƒ¨'],
            'employee_count': [50, 25, 30]
        })
    else:
        # é»˜è®¤å‘˜å·¥ä¿¡æ¯
        mock_data = pd.DataFrame({
            'employee_id': ['001', '002', '003'],
            'name': ['å¼ ä¸‰', 'æå››', 'ç‹äº”'],
            'position': ['å·¥ç¨‹å¸ˆ', 'äº§å“ç»ç†', 'è¿è¥ä¸“å‘˜']
        })
    
    print(f"âœ… [æ•°æ®åº“æ‰§è¡Œ {query_id}] è¿”å› {len(mock_data)} æ¡è®°å½•")
    return mock_data

def format_vanna_query_result(query_requirement: str, sql: str, results: pd.DataFrame, query_id: int) -> str:
    """
    æ ¼å¼åŒ–VannaæŸ¥è¯¢ç»“æœä¸ºç”¨æˆ·å‹å¥½çš„æ–‡æœ¬
    è¿™ä¸ªå‡½æ•°å°†åŸå§‹çš„SQLç»“æœè½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€æè¿°
    """
    
    result_text = f"""## æŸ¥è¯¢ç»“æœ - {query_requirement}

**ç”Ÿæˆçš„SQLæŸ¥è¯¢ï¼š**
```sql
{sql}
```

**æŸ¥è¯¢ç»“æœï¼š**
"""
    
    if len(results) == 0:
        result_text += "æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®ã€‚"
    else:
        # å°†DataFrameè½¬æ¢ä¸ºæ˜“è¯»çš„è¡¨æ ¼æ ¼å¼
        result_text += f"\nå…±æ‰¾åˆ° {len(results)} æ¡è®°å½•ï¼š\n\n"
        result_text += results.to_string(index=False)
        
        # æ·»åŠ ä¸€äº›ç»Ÿè®¡ä¿¡æ¯
        if len(results) > 5:
            result_text += f"\n\nï¼ˆæ˜¾ç¤ºå‰{min(len(results), 10)}æ¡è®°å½•ï¼‰"
    
    result_text += f"\n\n*æŸ¥è¯¢ID: {query_id}*"
    
    return result_text

# æœ€åï¼Œåœ¨graphæ„å»ºéƒ¨åˆ†ï¼Œå°†web_researchæ›¿æ¢ä¸ºdatabase_query_with_vanna
# æ‰¾åˆ°è¿™è¡Œï¼šbuilder.add_node("web_research", web_research)
# æ›¿æ¢ä¸ºï¼š
builder.add_node("web_research", database_query_with_vanna)
```

### ç¬¬å››æ­¥ï¼šåˆå§‹åŒ–å’Œæµ‹è¯•

æœ€åï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿ç³»ç»Ÿæ­£ç¡®åˆå§‹åŒ–ï¼š

**backend/src/agent/vanna_init.py**
```python
"""
Vannaåˆå§‹åŒ–è„šæœ¬
åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡ï¼Œç¡®ä¿Vannaæ¨¡å‹å·²ç»è®­ç»ƒå®Œæˆ
"""

import os
from pathlib import Path
from agent.vanna_trainer import train_vanna_with_hr_data

def ensure_vanna_trained():
    """
    ç¡®ä¿Vannaæ¨¡å‹å·²ç»è®­ç»ƒ
    è¿™ä¸ªå‡½æ•°æ£€æŸ¥æ˜¯å¦å­˜åœ¨è®­ç»ƒå¥½çš„æ¨¡å‹ï¼Œå¦‚æœæ²¡æœ‰å°±è¿›è¡Œè®­ç»ƒ
    """
    
    # æ£€æŸ¥Vannaæ•°æ®ç›®å½•æ˜¯å¦å­˜åœ¨
    vanna_data_path = Path("./vanna_chromadb")
    
    if not vanna_data_path.exists() or len(list(vanna_data_path.glob("*"))) == 0:
        print("ğŸ“ æ£€æµ‹åˆ°Vannaæœªè®­ç»ƒï¼Œå¼€å§‹è‡ªåŠ¨è®­ç»ƒ...")
        train_vanna_with_hr_data()
        print("âœ… Vannaè®­ç»ƒå®Œæˆï¼")
    else:
        print("âœ… Vannaæ¨¡å‹å·²å­˜åœ¨ï¼Œè·³è¿‡è®­ç»ƒ")

if __name__ == "__main__":
    ensure_vanna_trained()
```

**åœ¨ä½ çš„ä¸»åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨åˆå§‹åŒ–ï¼š**

ä¿®æ”¹ **backend/src/agent/app.py**ï¼Œåœ¨æ–‡ä»¶å¼€å¤´æ·»åŠ ï¼š

```python
# åœ¨å…¶ä»–å¯¼å…¥ä¹‹åæ·»åŠ 
from agent.vanna_init import ensure_vanna_trained

# åœ¨åº”ç”¨å¯åŠ¨æ—¶ç¡®ä¿Vannaå·²è®­ç»ƒ
ensure_vanna_trained()
```

## ä¸ºä»€ä¹ˆè¿™ä¸ªæ–¹æ¡ˆæ›´ä¼˜ç§€

é€šè¿‡ä½¿ç”¨Vannaï¼Œä½ è·å¾—äº†ä»¥ä¸‹é‡è¦ä¼˜åŠ¿ï¼š

**æˆç†Ÿçš„RAGæ¶æ„ï¼š** Vannaç»è¿‡äº†å¤§é‡å®é™…é¡¹ç›®çš„éªŒè¯ï¼Œå®ƒçš„å‘é‡æ£€ç´¢å’Œpromptå·¥ç¨‹éƒ½ç»è¿‡äº†ç²¾å¿ƒä¼˜åŒ–ï¼Œæ¯”æˆ‘ä»¬æ‰‹å·¥ç¼–å†™çš„æ–¹æ¡ˆæ›´å¯é ã€‚

**è‡ªåŠ¨åŒ–çš„å­¦ä¹ æœºåˆ¶ï¼š** éšç€ä½¿ç”¨ï¼ŒVannaå¯ä»¥é€šè¿‡æˆåŠŸçš„æŸ¥è¯¢æ¡ˆä¾‹æ¥ä¸æ–­æ”¹è¿›ï¼Œè¿™æ„å‘³ç€ç³»ç»Ÿä¼šè¶Šç”¨è¶Šæ™ºèƒ½ã€‚

**æ›´å¥½çš„é”™è¯¯å¤„ç†ï¼š** Vannaå†…ç½®äº†SQLéªŒè¯ã€è¯­æ³•æ£€æŸ¥ç­‰æœºåˆ¶ï¼Œå‡å°‘äº†ç”Ÿæˆé”™è¯¯SQLçš„å¯èƒ½æ€§ã€‚

**æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ï¼š** å½“ä½ éœ€è¦æ”¯æŒæ–°çš„æ•°æ®åº“æˆ–ä¿®æ”¹schemaæ—¶ï¼Œåªéœ€è¦é‡æ–°è®­ç»ƒç›¸å…³éƒ¨åˆ†ï¼Œè€Œä¸éœ€è¦ä¿®æ”¹å¤§é‡ä»£ç ã€‚

**ä¸°å¯Œçš„ç”Ÿæ€ç³»ç»Ÿï¼š** Vannaæ”¯æŒå¤šç§æ•°æ®åº“ã€å‘é‡å­˜å‚¨å’Œå‰ç«¯ç•Œé¢ï¼Œä¸ºæœªæ¥çš„æ‰©å±•æä¾›äº†æ›´å¤šå¯èƒ½æ€§ã€‚

ç°åœ¨ä½ çš„ç³»ç»Ÿæ¶æ„å˜å¾—éå¸¸ä¼˜é›…ï¼šç”¨æˆ·è¾“å…¥é€šè¿‡ç¬¬ä¸€ä¸ªAgentè½¬æ¢ä¸ºç»“æ„åŒ–çš„æŸ¥è¯¢éœ€æ±‚ï¼Œç„¶åVannaè´Ÿè´£å°†è¿™äº›éœ€æ±‚è½¬æ¢ä¸ºç²¾ç¡®çš„SQLå¹¶æ‰§è¡Œï¼Œæœ€åreflection Agentå¯¹ç»“æœè¿›è¡Œåˆ†æå’Œæ€»ç»“ã€‚è¿™æ˜¯ä¸€ä¸ªçœŸæ­£çš„ä¸“ä¸šçº§æ¶æ„ï¼

ä½ è§‰å¾—è¿™ä¸ªé›†æˆæ–¹æ¡ˆæ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆå…·ä½“çš„æ•°æ®åº“è¿æ¥æˆ–éƒ¨ç½²é—®é¢˜éœ€è¦æˆ‘è¿›ä¸€æ­¥å¸®åŠ©è§£å†³å—ï¼Ÿ